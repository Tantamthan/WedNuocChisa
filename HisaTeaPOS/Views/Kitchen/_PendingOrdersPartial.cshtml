@model IEnumerable<HisaTeaPOS.Models.DonHang>

@if (Model == null || !Model.Any())
{
    <div class="text-center py-20 bg-white rounded-xl border border-dashed border-gray-300 text-gray-400">
        <i data-lucide="coffee" class="w-16 h-16 mx-auto mb-4 opacity-20"></i>
        <p>Hiện không có đơn hàng nào cần làm.</p>
    </div>
}
else
{
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        @foreach (var order in Model)
        {
            var minutes = (int)(DateTime.Now - (order.NgayTao ?? DateTime.Now)).TotalMinutes;
            bool isLate = minutes > 10;

            <div class="bg-white rounded-xl shadow-sm border overflow-hidden flex flex-col animate-in fade-in slide-in-from-bottom-4 @(isLate ? "border-red-300 ring-1 ring-red-300" : "border-gray-200")">

                <div class="p-4 flex justify-between items-start @(isLate ? "bg-red-50" : "bg-orange-50")">
                    <div>
                        <div class="font-bold text-lg text-gray-800">#@order.MaDon.ToString("D4")</div>
                        <div class="text-xs text-gray-500 flex items-center gap-1 mt-1">
                            <i data-lucide="clock" class="w-3 h-3"></i> @order.NgayTao.Value.ToString("HH:mm")
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs font-bold uppercase px-2 py-1 rounded border flex items-center gap-1 @(isLate ? "bg-red-100 text-red-600 border-red-200" : "bg-white text-orange-600 border-orange-200")">
                            @minutes PHÚT TRƯỚC
                        </div>
                    </div>
                </div>

                <div class="p-4 flex-1 space-y-4">
                    @foreach (var item in order.ChiTietDonHangs)
                    {
                        // Tính hệ số Size và Đường
                        double sizeMult = 1.0;
                        if (item.KichCo == "L") { sizeMult = 1.3; }
                        else if (item.KichCo == "S") { sizeMult = 0.8; }

                        double sugarMult = (item.MucDuong ?? 100) / 100.0;

                        <div class="border-b border-dashed border-gray-100 last:border-0 pb-3 last:pb-0">
                            <div>
                                <span class="font-bold text-gray-800 text-base">
                                    @item.SoLuong x @item.SanPham.Ten
                                </span>
                                <span class="ml-1 bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded text-xs font-bold">
                                    Size @item.KichCo
                                </span>

                                <div class="text-gray-500 text-xs mt-1 mb-2">
                                    @item.MucDuong% Đường
                                </div>

                                <div class="bg-blue-50 p-3 rounded-lg border border-blue-100 text-xs text-blue-800 space-y-2">

                                    <div>
                                        <div class="font-bold uppercase text-[10px] text-blue-400 mb-1">CÔNG THỨC PHA CHẾ (1 LY):</div>
                                        @if (item.SanPham.CongThucs.Any())
                                        {
                                            foreach (var ct in item.SanPham.CongThucs)
                                            {
                                                double baseAmount = (double)ct.DinhLuong;
                                                double finalAmount = baseAmount * sizeMult;
                                                if (ct.NguyenLieu.Ten.ToLower().Contains("đường")) { finalAmount *= sugarMult; }

                                                <div class="flex justify-between items-center border-b border-blue-100/50 pb-1 last:border-0">
                                                    <span>• @ct.NguyenLieu.Ten:</span>
                                                    <span class="font-bold">@Math.Round(finalAmount, 1) @ct.NguyenLieu.DonVi</span>
                                                </div>
                                            }
                                        }
                                        else
                                        {
                                            <div class="text-blue-300 italic">Chưa có công thức</div>
                                        }
                                    </div>

                                    @if (item.ChiTietToppings != null && item.ChiTietToppings.Any())
                                    {
                                        <div class="pt-2 border-t border-blue-200 mt-1">
                                            <div class="font-bold uppercase text-[10px] text-orange-500 mb-1">TOPPING THÊM:</div>
                                            @foreach (var top in item.ChiTietToppings)
                                            {
                                                <div class="flex justify-between items-center text-orange-700">
                                                    <span class="font-bold">+ @top.Topping.Ten</span>

                                                    @if (top.Topping.NguyenLieu != null)
                                                    {
                                                        <span class="bg-orange-100 px-1.5 rounded text-[10px]">
                                                            @Math.Round((double)(top.Topping.DinhLuong ?? 0), 0) @top.Topping.NguyenLieu.DonVi
                                                        </span>
                                                    }
                                                    else
                                                    {
                                                        <span class="bg-orange-100 px-1.5 rounded text-[10px]">1 phần</span>
                                                    }
                                                </div>
                                            }
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <div class="p-3 bg-gray-50 border-t">
                    <button onclick="completeOrder(@order.MaDon)" class="w-full py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg text-sm font-bold shadow-sm flex items-center justify-center gap-1">
                        <i data-lucide="check-square" class="w-4 h-4"></i> Xong
                    </button>
                </div>
            </div>
        }
    </div>
}