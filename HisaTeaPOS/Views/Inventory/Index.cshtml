@model IEnumerable<HisaTeaPOS.Models.NguyenLieu>
@{
    ViewBag.Title = "Kho Nguyên Liệu";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var listTopping = Model.Where(x => x.Toppings != null && x.Toppings.Count > 0).ToList();
    var listNL = Model.Where(x => x.Toppings == null || x.Toppings.Count == 0).ToList();
}

<div class="space-y-8 animate-in fade-in duration-300">
    <div class="bg-white rounded-xl shadow-sm border p-5 flex justify-between items-center">
        <h3 class="font-bold text-xl text-gray-800 flex items-center gap-2">
            <i data-lucide="package" class="w-5 h-5 text-orange-600"></i>
            Quản lý Kho
        </h3>
        <button onclick="document.getElementById('addModal').classList.remove('hidden')" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-bold text-sm flex items-center gap-2 shadow-md transition-colors">
            <i data-lucide="plus" class="w-4 h-4"></i> Thêm nguyên liệu
        </button>
    </div>

    <div>
        <div class="flex items-center gap-2 mb-3 pb-2 border-b border-gray-200">
            <div class="bg-blue-100 p-1.5 rounded-lg text-blue-600"><i data-lucide="flask-conical" class="w-5 h-5"></i></div>
            <h4 class="font-bold text-lg text-gray-700">Nguyên liệu pha chế</h4>
            <span class="text-xs bg-gray-100 px-2 py-0.5 rounded text-gray-500">@listNL.Count loại</span>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            @foreach (var item in listNL)
            {@RenderInventoryCard(item, "blue")}
        </div>
    </div>

    <div>
        <div class="flex items-center gap-2 mb-3 pb-2 border-b border-gray-200">
            <div class="bg-orange-100 p-1.5 rounded-lg text-orange-600"><i data-lucide="layers" class="w-5 h-5"></i></div>
            <h4 class="font-bold text-lg text-gray-700">Kho Topping</h4>
            <span class="text-xs bg-gray-100 px-2 py-0.5 rounded text-gray-500">@listTopping.Count loại</span>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            @foreach (var item in listTopping)
            {@RenderInventoryCard(item, "orange")}
        </div>
    </div>
</div>

@helper RenderInventoryCard(HisaTeaPOS.Models.NguyenLieu item, string theme)
{
    var current = item.TonKho ?? 0;
    var min = item.DinhMucToiThieu ?? 0;
    bool isLow = current < min;
    var maxBar = Math.Max(min, 1) * 3;
    var percent = (maxBar > 0) ? Math.Min((current / maxBar) * 100, 100) : 0;
    var borderColor = theme == "blue" ? "hover:border-blue-300" : "hover:border-orange-300";

    // Lấy thông tin Topping liên kết (nếu có)
    var linkedTopping = item.Toppings.FirstOrDefault();
    decimal giaBan = linkedTopping != null ? linkedTopping.GiaBan : 0;
    decimal dinhLuong = linkedTopping != null ? (linkedTopping.DinhLuong ?? 0) : 0;
    bool isTopping = linkedTopping != null;

    <div class="p-4 rounded-xl border transition-all relative group bg-white border-gray-200 @borderColor shadow-sm">

        <button type="button"
                onclick="openEditModal(@item.MaNL, '@HttpUtility.JavaScriptStringEncode(item.Ten)', '@item.DonVi', @(item.DinhMucToiThieu ?? 0), '@HttpUtility.JavaScriptStringEncode(item.XuatXu ?? "")', '@HttpUtility.JavaScriptStringEncode(item.ChungNhan ?? "")', @(isTopping.ToString().ToLower()), @giaBan, @dinhLuong)"
                class="absolute top-2 right-2 p-1.5 text-gray-400 hover:text-blue-500 hover:bg-blue-50 rounded-lg transition-colors">
            <i data-lucide="edit-2" class="w-4 h-4"></i>
        </button>

        <div class="flex justify-between items-start mb-2 pr-6">
            <div class="font-bold text-gray-800">@item.Ten</div>
        </div>
        <div class="flex items-baseline gap-1 mb-2">
            <span class="text-2xl font-bold @(isLow ? "text-red-600" : "text-gray-800")">
                @string.Format("{0:N0}", current)
            </span>
            <span class="text-sm text-gray-500">@item.DonVi</span>
        </div>

        <div class="w-full bg-gray-100 rounded-full h-1.5 mb-3 overflow-hidden">
            <div class="h-full rounded-full transition-all duration-500 @(isLow ? "bg-red-500" : (theme == "blue" ? "bg-blue-500" : "bg-orange-500"))" style="width: @percent%"></div>
        </div>

        @if (isTopping)
        {
            <div class="mb-3 flex gap-2 text-[10px] text-gray-500 bg-gray-50 p-1.5 rounded border border-gray-100">
                <span class="font-bold text-orange-600">Topping:</span>
                <span>Trừ @string.Format("{0:N0}", dinhLuong) @item.DonVi / Bán @string.Format("{0:N0}", giaBan)đ</span>
            </div>
        }

        <form action="@Url.Action("QuickUpdate", "Inventory")" method="post" class="flex gap-2">
            <input type="hidden" name="id" value="@item.MaNL" />
            <input type="number" name="amount" placeholder="Nhập SL..." required step="0.01" class="w-full min-w-0 px-3 py-1.5 border rounded-lg text-sm outline-none focus:border-gray-400" />
            <button type="submit" class="px-3 py-1.5 text-white rounded-lg text-sm font-bold shadow-sm @(theme == "blue" ? "bg-blue-600 hover:bg-blue-700" : "bg-orange-600 hover:bg-orange-700")">+</button>
        </form>
    </div>
}

<div id="editModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeEditModal()"></div>
    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-xl shadow-2xl w-full max-w-md p-6 animate-in fade-in zoom-in duration-200">
        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
            <i data-lucide="edit" class="w-5 h-5 text-orange-600"></i> Chỉnh sửa thông tin
        </h3>
        <form action="@Url.Action("Edit", "Inventory")" method="post" class="space-y-4">
            <input type="hidden" id="edit-id" name="MaNL" />

            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tên</label>
                <input type="text" id="edit-name" name="Ten" required class="w-full px-3 py-2 border rounded-lg focus:border-orange-500 outline-none" />
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Đơn vị</label>
                    <select id="edit-unit" name="DonVi" class="w-full px-3 py-2 border rounded-lg bg-white">
                        <option value="g">Gam (g)</option>
                        <option value="ml">Mililit (ml)</option>
                        <option value="hộp">Hộp</option>
                        <option value="quả">Quả</option>
                        <option value="bao">Bao</option>
                        <option value="lon">Lon</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Định mức tối thiểu</label>
                    <input type="number" id="edit-min" name="DinhMucToiThieu" required class="w-full px-3 py-2 border rounded-lg" />
                </div>
            </div>

            <div id="edit-topping-area" class="hidden space-y-3 p-3 bg-orange-50 rounded-lg border border-orange-200">
                <div class="flex items-center gap-2 text-orange-700 font-bold text-sm border-b border-orange-200 pb-2 mb-2">
                    <i data-lucide="layers" class="w-4 h-4"></i> Cấu hình Topping
                </div>
                <div>
                    <label class="block text-xs font-bold text-orange-600 uppercase mb-1">Giá bán (VNĐ)</label>
                    <input type="number" id="edit-price" name="GiaBanTopping" step="500" class="w-full px-3 py-2 border rounded-lg focus:ring-1 focus:ring-orange-500 outline-none" />
                </div>
                <div>
                    <label class="block text-xs font-bold text-orange-600 uppercase mb-1">Định lượng trừ kho (g/ml)</label>
                    <input type="number" id="edit-dinhluong" name="DinhLuongTopping" step="0.1" class="w-full px-3 py-2 border rounded-lg focus:ring-1 focus:ring-orange-500 outline-none" />
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Xuất xứ</label>
                    <input type="text" id="edit-origin" name="XuatXu" class="w-full px-3 py-2 border rounded-lg outline-none" />
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Chứng nhận</label>
                    <input type="text" id="edit-cert" name="ChungNhan" class="w-full px-3 py-2 border rounded-lg outline-none" />
                </div>
            </div>

            <div class="flex gap-3 pt-2">
                <button type="button" onclick="closeEditModal()" class="flex-1 py-2 bg-gray-100 text-gray-700 font-bold rounded-lg hover:bg-gray-200">Hủy</button>
                <button type="submit" class="flex-1 py-2 bg-orange-600 text-white font-bold rounded-lg shadow-lg hover:bg-orange-700">Lưu Thay Đổi</button>
            </div>
        </form>
    </div>
</div>
<div id="addModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeAddModal()"></div>
    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-xl shadow-2xl w-full max-w-md p-6 animate-in fade-in zoom-in duration-200">
        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
            <i data-lucide="plus-circle" class="w-5 h-5 text-green-600"></i> Thêm nguyên liệu mới
        </h3>
        <form action="@Url.Action("Create", "Inventory")" method="post" class="space-y-4">
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tên nguyên liệu</label>
                <input type="text" name="Ten" required class="w-full px-3 py-2 border rounded-lg focus:border-green-500 outline-none" placeholder="VD: Trà lài, Đào hộp..." />
            </div>

            <!-- THÊM CHECKBOX NÀY -->
            <div class="flex items-center gap-2 p-3 bg-orange-50 rounded-lg border border-orange-200">
                <input type="checkbox" id="isTopping" name="IsTopping" value="true" class="w-4 h-4 text-orange-600 rounded focus:ring-orange-500" />
                <label for="isTopping" class="text-sm font-semibold text-orange-700 cursor-pointer flex items-center gap-2">
                    <i data-lucide="layers" class="w-4 h-4"></i>
                    Đây là Topping (tự động tạo mục topping)
                </label>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Đơn vị</label>
                    <select name="DonVi" class="w-full px-3 py-2 border rounded-lg bg-white">
                        <option value="g">Gam (g)</option>
                        <option value="ml">Mililit (ml)</option>
                        <option value="hộp">Hộp</option>
                        <option value="quả">Quả</option>
                        <option value="bao">Bao</option>
                        <option value="lon">Lon</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tồn đầu kỳ</label>
                    <input type="number" name="TonKho" class="w-full px-3 py-2 border rounded-lg" placeholder="0" />
                </div>
            </div>

            <!-- THÊM TRƯỜNG GIÁ BÁN CHO TOPPING (ẨN/HIỆN THEO CHECKBOX) -->
            <div id="toppingFields" class="hidden space-y-3 p-3 bg-orange-50 rounded-lg border border-orange-200">
                <div>
                    <label class="block text-xs font-bold text-orange-600 uppercase mb-1">Giá bán topping</label>
                    <input type="number" name="GiaBanTopping" step="0.01" class="w-full px-3 py-2 border rounded-lg" placeholder="0" />
                </div>
                <div>
                    <label class="block text-xs font-bold text-orange-600 uppercase mb-1">Định lượng (g/ml)</label>
                    <input type="number" name="DinhLuongTopping" step="0.01" class="w-full px-3 py-2 border rounded-lg" placeholder="50" />
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Định mức tối thiểu</label>
                    <input type="number" name="DinhMucToiThieu" required class="w-full px-3 py-2 border rounded-lg" value="100" />
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Xuất xứ</label>
                    <input type="text" name="XuatXu" class="w-full px-3 py-2 border rounded-lg outline-none" />
                </div>
            </div>

            <div class="flex gap-3 pt-2">
                <button type="button" onclick="closeAddModal()" class="flex-1 py-2 bg-gray-100 text-gray-700 font-bold rounded-lg hover:bg-gray-200">Hủy</button>
                <button type="submit" class="flex-1 py-2 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 shadow-lg">Thêm Mới</button>
            </div>
        </form>
    </div>
</div>@section scripts {
    <script>
        // Kích hoạt Icon Lucide khi trang vừa tải xong
        lucide.createIcons();

        // Xử lý sự kiện Checkbox "Đây là Topping" trong Modal Thêm mới
        // (Hiện/Ẩn các trường giá bán, định lượng)
        const isToppingCheckbox = document.getElementById('isTopping');
        if (isToppingCheckbox) {
            isToppingCheckbox.addEventListener('change', function () {
                const toppingFields = document.getElementById('toppingFields');
                if (this.checked) {
                    toppingFields.classList.remove('hidden');
                } else {
                    toppingFields.classList.add('hidden');
                }
            });
        }

        // Hàm mở Modal Sửa (Nhận thông tin từ nút Edit và điền vào Form)
        function openEditModal(id, name, unit, min, origin, cert, isTopping, price, amount) {
            document.getElementById('edit-id').value = id;
            document.getElementById('edit-name').value = name;
            document.getElementById('edit-unit').value = unit;
            document.getElementById('edit-min').value = min;
            document.getElementById('edit-origin').value = origin;
            document.getElementById('edit-cert').value = cert;

            // Xử lý phần Topping trong Modal Sửa
            const toppingArea = document.getElementById('edit-topping-area');
            if (isTopping) {
                toppingArea.classList.remove('hidden');
                document.getElementById('edit-price').value = price;
                document.getElementById('edit-dinhluong').value = amount;
            } else {
                toppingArea.classList.add('hidden');
                document.getElementById('edit-price').value = '';
                document.getElementById('edit-dinhluong').value = '';
            }

            document.getElementById('editModal').classList.remove('hidden');
            lucide.createIcons(); // Render lại icon bên trong modal nếu cần
        }

        // Hàm đóng Modal Sửa
        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
        }

        // Hàm đóng Modal Thêm mới
        function closeAddModal() {
            document.getElementById('addModal').classList.add('hidden');

            // Reset form về trạng thái ban đầu để lần sau mở lên không bị lưu dữ liệu cũ
            document.getElementById('isTopping').checked = false;
            document.getElementById('toppingFields').classList.add('hidden');

            // Có thể reset thêm các input khác nếu cần, ví dụ:
            // document.querySelector('#addModal form').reset();
        }
    </script>
}
